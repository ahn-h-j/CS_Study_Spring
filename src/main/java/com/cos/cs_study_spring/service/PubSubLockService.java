package com.cos.cs_study_spring.service;

import com.cos.cs_study_spring.domain.Stock;
import com.cos.cs_study_spring.repository.StockRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.concurrent.TimeUnit;

/**
 * ============================================================================
 * Case 4: Pub/Sub Lock (Redisson ì‚¬ìš©)
 * ============================================================================
 *
 * [ë™ì‘ ì›ë¦¬]
 * 1. ë½ íšë“ ì‹œë„ (tryLock)
 * 2. ë½ íšë“ ì‹¤íŒ¨ ì‹œ, Redis Pub/Sub ì±„ë„ì„ êµ¬ë…í•˜ê³  ëŒ€ê¸°
 * 3. ë½ì´ í•´ì œë˜ë©´ PUBLISH ì‹ í˜¸ë¥¼ ë°›ì•„ ì¦‰ì‹œ ë½ íšë“ ì‹œë„
 * 4. ë½ íšë“ ì„±ê³µ ì‹œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰ í›„ ë½ í•´ì œ + PUBLISH
 *
 * [ì¥ì ]
 * - Redis ì„œë²„ ë¶€í•˜ ìµœì†Œí™” (Polling ì—†ìŒ)
 * - ë½ í•´ì œ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ â†’ ë¹ ë¥¸ ë°˜ì‘ì„±
 * - Redissonì´ ëª¨ë“  ë³µì¡í•œ ë¡œì§ ì²˜ë¦¬ (ì¬ì‹œë„, íƒ€ì„ì•„ì›ƒ, ì‹ í˜¸ ìœ ì‹¤ ë°©ì§€)
 *
 * [ë‹¨ì ]
 * - ì¶”ê°€ ì˜ì¡´ì„± (Redisson ë¼ì´ë¸ŒëŸ¬ë¦¬) í•„ìš”
 * - Pub/Sub ì±„ë„ ê´€ë¦¬ ì˜¤ë²„í—¤ë“œ
 * - ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ ì‹œ êµ¬ë… ìƒíƒœ ë³µêµ¬ í•„ìš”
 *
 * [Redis ì„œë²„ ë¶€í•˜: ìµœì†Œ âœ…]
 * ============================================================================
 * | ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ íšŸìˆ˜:                                                        |
 * | - ë½ íšë“ ì‹œë„: 1íšŒ                                                       |
 * | - (ì‹¤íŒ¨ ì‹œ) ì±„ë„ êµ¬ë…: 1íšŒ                                                |
 * | - ë½ í•´ì œ ì‹ í˜¸ ìˆ˜ì‹  ëŒ€ê¸°: ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ ì—†ìŒ (Push ë°©ì‹)                    |
 * | - ë½ í•´ì œ: 1íšŒ + PUBLISH                                                 |
 * |                                                                          |
 * | âš¡ Spin Lock ë°©ì‹ê³¼ ë¹„êµ:                                                  |
 * | - Spin Lock: ë½ íšë“ê¹Œì§€ Në²ˆ í˜¸ì¶œ (N = ëŒ€ê¸° ì‹œê°„ / ì¬ì‹œë„ ê°„ê²©)             |
 * | - Pub/Sub: ë½ íšë“ ì‹¤íŒ¨í•´ë„ ì¶”ê°€ í˜¸ì¶œ ì—†ìŒ (ì‹ í˜¸ ëŒ€ê¸°ë§Œ í•¨)                 |
 * ============================================================================
 *
 *
 * ============================================================================
 * [Redissonì˜ 'êµ¬ë… ì§í›„ ì¬ì‹œë„' ë¡œì§ - ì‹ í˜¸ ìœ ì‹¤ ë°©ì§€]
 * ============================================================================
 *
 * ğŸš¨ ë¬¸ì œ ìƒí™©: ì‹ í˜¸ ìœ ì‹¤ (Signal Loss)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *
 * [ì¼ë°˜ì ì¸ Pub/Subì˜ ë¬¸ì œì ]
 *
 * ì‹œê°„ â†’
 *
 * Thread A (ë½ ë³´ìœ ì):  â”€â”€â”€[ì‘ì—… ì¤‘]â”€â”€â”€[unlock + PUBLISH]â”€â”€â”€
 * Thread B (ëŒ€ê¸°ì):     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[SUBSCRIBE]â”€â”€â”€â”€â”€[ëŒ€ê¸° ì¤‘...]â”€â”€(ì˜ì›íˆ ëŒ€ê¸°)
 *                                           â†‘
 *                                    ì´ ìˆœê°„ì— PUBLISHê°€ ë°œìƒí•˜ë©´?
 *                                    â†’ êµ¬ë… ì „ì´ë¯€ë¡œ ì‹ í˜¸ë¥¼ ë°›ì§€ ëª»í•¨!
 *
 * ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Redissonì€ 'êµ¬ë… ì§í›„ ì¬ì‹œë„' ë¡œì§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 *
 * âœ… Redissonì˜ í•´ê²°ì±…: êµ¬ë… ì™„ë£Œ ì§í›„ ì¦‰ì‹œ ë½ íšë“ ì¬ì‹œë„
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *
 * Redisson ë‚´ë¶€ ì½”ë“œ (RedissonLock.java):
 *
 * ```
 * public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) {
 *     // 1. ì²« ë²ˆì§¸ ë½ íšë“ ì‹œë„
 *     Long ttl = tryAcquire(leaseTime, unit);
 *     if (ttl == null) {
 *         return true;  // ë½ íšë“ ì„±ê³µ
 *     }
 *
 *     // 2. Pub/Sub ì±„ë„ êµ¬ë…
 *     RFuture<RedissonLockEntry> subscribeFuture = subscribe();
 *     subscribeFuture.sync();  // êµ¬ë… ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
 *
 *     try {
 *         while (true) {
 *             // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *             // â”‚  ğŸ”‘ í•µì‹¬: êµ¬ë… ì™„ë£Œ ì§í›„ ì¦‰ì‹œ ë½ íšë“ ì¬ì‹œë„!            â”‚
 *             // â”‚  â†’ êµ¬ë… ì „ì— PUBLISHê°€ ë°œìƒí–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„             â”‚
 *             // â”‚  â†’ ì´ë¯¸ ë½ì´ í•´ì œë˜ì—ˆë‹¤ë©´ ì—¬ê¸°ì„œ íšë“ ì„±ê³µ              â”‚
 *             // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *             ttl = tryAcquire(leaseTime, unit);
 *             if (ttl == null) {
 *                 return true;  // ë½ íšë“ ì„±ê³µ!
 *             }
 *
 *             // 3. PUBLISH ì‹ í˜¸ ëŒ€ê¸° (ttl ë™ì•ˆë§Œ)
 *             entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
 *
 *             // 4. ì‹ í˜¸ ë°›ìœ¼ë©´ ë‹¤ì‹œ ë½ íšë“ ì‹œë„ (while ë£¨í”„)
 *         }
 *     } finally {
 *         unsubscribe(subscribeFuture);
 *     }
 * }
 * ```
 *
 * [ë™ì‘ íë¦„]
 *
 * ì‹œê°„ â†’
 *
 * Thread A:  â”€â”€â”€[unlock + PUBLISH]â”€â”€â”€
 *                      â†“ (ì‹ í˜¸ ë°œìƒ)
 * Thread B:  â”€[tryLock ì‹¤íŒ¨]â”€[SUBSCRIBE ì™„ë£Œ]â”€[ì¦‰ì‹œ ì¬ì‹œë„!]â”€[íšë“ ì„±ê³µ âœ…]
 *                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *                                       êµ¬ë… ì§í›„ ì¬ì‹œë„ë¡œ ì‹ í˜¸ ìœ ì‹¤ ë°©ì§€
 *
 * ============================================================================
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class PubSubLockService {

    private final RedissonClient redissonClient;
    private final StockRepository stockRepository;

    private static final String LOCK_KEY = "stock:lock:pubsub";

    /**
     * Redisson Pub/Sub Lockìœ¼ë¡œ ì¬ê³  ê°ì†Œ
     *
     * @throws InterruptedException ë½ ëŒ€ê¸° ì¤‘ ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì‹œ
     */
    public void decrease(Long id) throws InterruptedException {
        // ========================================
        // 1. ë¶„ì‚° ë½ ê°ì²´ íšë“
        // ========================================
        // RLock: Redissonì˜ ë¶„ì‚° ë½ ì¸í„°í˜ì´ìŠ¤
        // - ë‚´ë¶€ì ìœ¼ë¡œ Redisì˜ Hash ìë£Œêµ¬ì¡° ì‚¬ìš©
        // - Pub/Sub ì±„ë„ì„ í†µí•œ ë½ í•´ì œ ì•Œë¦¼
        RLock lock = redissonClient.getLock(LOCK_KEY);

        try {
            // ========================================
            // 2. ë½ íšë“ ì‹œë„ (with Timeout)
            // ========================================
            // tryLock(waitTime, leaseTime, unit)
            // - waitTime: ë½ íšë“ì„ ìœ„í•´ ìµœëŒ€ ëŒ€ê¸°í•  ì‹œê°„ (10ì´ˆ)
            // - leaseTime: ë½ ë³´ìœ  ìµœëŒ€ ì‹œê°„ (3ì´ˆ), ìë™ í•´ì œ
            // - ë°˜í™˜ê°’: ë½ íšë“ ì„±ê³µ ì—¬ë¶€
            //
            // ë‚´ë¶€ ë™ì‘:
            // 1) ì²« ë²ˆì§¸ tryAcquire ì‹œë„
            // 2) ì‹¤íŒ¨ ì‹œ Pub/Sub ì±„ë„ êµ¬ë…
            // 3) â­ êµ¬ë… ì™„ë£Œ ì§í›„ ì¦‰ì‹œ tryAcquire ì¬ì‹œë„ (ì‹ í˜¸ ìœ ì‹¤ ë°©ì§€)
            // 4) ì‹¤íŒ¨ ì‹œ PUBLISH ì‹ í˜¸ ëŒ€ê¸°
            // 5) ì‹ í˜¸ ìˆ˜ì‹  ì‹œ ë‹¤ì‹œ tryAcquire ì‹œë„
            boolean acquired = lock.tryLock(20, 3, TimeUnit.SECONDS);

            if (!acquired) {
                log.warn("ë½ íšë“ ì‹¤íŒ¨ - íƒ€ì„ì•„ì›ƒ");
                throw new RuntimeException("ë½ íšë“ ì‹¤íŒ¨");
            }

            // ========================================
            // 3. ì„ê³„ ì˜ì—­ (Critical Section)
            // ========================================
            actualDecrease(id);

        } finally {
            // ========================================
            // 4. ë½ í•´ì œ + PUBLISH
            // ========================================
            // unlock() í˜¸ì¶œ ì‹œ:
            // 1) Redisì—ì„œ ë½ í‚¤ ì‚­ì œ
            // 2) Pub/Sub ì±„ë„ë¡œ PUBLISH (ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œì—ê²Œ ì•Œë¦¼)
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }

    /**
     * ì‹¤ì œ ì¬ê³  ê°ì†Œ ë¡œì§ (ë³„ë„ íŠ¸ëœì­ì…˜)
     */
    @Transactional
    public void actualDecrease(Long id) {
        Stock stock = stockRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Stock not found"));
        stock.decrease();
        stockRepository.saveAndFlush(stock);
    }
}
